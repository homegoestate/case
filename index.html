<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>宏國x易丞地政 - 案件指揮艙 v34.8 (Final URL)</title>
    
    <script>
        window.onerror = function(msg, url, line, col, error) {
            if (msg.includes("ResizeObserver")) return false;
            alert("⚠️ 系統錯誤：\n" + msg + "\n\n行數：" + line);
            return false;
        };
    </script>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Michroma&display=swap');
        :root { --nexus-navy: #0F2E46; --nexus-gold: #C5A065; --nexus-bg: #f3f4f6; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--nexus-bg); -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        .text-navy { color: var(--nexus-navy); } .bg-navy { background-color: var(--nexus-navy); } .text-gold { color: var(--nexus-gold); } .bg-gold { background-color: var(--nexus-gold); }
        .nexus-input { width: 100%; padding: 0.5rem 0.7rem; border: 1px solid #d1d5db; border-radius: 0.375rem; background-color: white; transition: all 0.2s; font-size: 1rem; font-weight: 500; line-height: 1.5; margin-bottom: 2px; }
        .nexus-input:focus { border-color: var(--nexus-navy); ring: 3px solid rgba(15, 46, 70, 0.1); outline: none; background-color: #fffbf0; }
        label { display: block; margin-bottom: 4px; font-size: 0.95rem; color: #4b5563; font-weight: 600; }
        .unit-tag { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #9ca3af; font-size: 0.9rem; font-weight: bold; pointer-events: none; }
        .timeline-wrapper { position: relative; padding: 15px 0; margin-bottom: 10px; overflow-x: auto; }
        .timeline-line-bg { position: absolute; top: 25px; left: 40px; right: 40px; height: 4px; background: #e5e7eb; z-index: 0; min-width: 300px; }
        .timeline-steps { display: flex; justify-content: space-between; position: relative; z-index: 10; min-width: 300px; }
        .step-item { display: flex; flex-direction: column; align-items: center; width: 100px; text-align: center; cursor: pointer; }
        .step-icon { width: 42px; height: 42px; border-radius: 50%; background: white; border: 3px solid #e5e7eb; display: flex; align-items: center; justify-content: center; color: #9ca3af; font-size: 1.2rem; margin-bottom: 6px; transition: all 0.3s; }
        .step-item.active .step-icon { border-color: var(--nexus-gold); background-color: var(--nexus-navy); color: var(--nexus-gold); transform: scale(1.1); }
        .step-title { font-weight: 700; color: var(--nexus-navy); font-size: 1rem; margin-bottom: 2px; }
        .step-date { font-family: 'Michroma', monospace; font-size: 0.85rem; color: #666; background: #eef2f6; padding: 2px 8px; border-radius: 4px; min-height: 24px; min-width: 80px; }
        .doc-row { display: flex; align-items: center; justify-content: space-between; background: #fff; border: 1px solid #e5e7eb; padding: 10px 12px; margin-bottom: 8px; border-radius: 6px; }
        .doc-checkbox { transform: scale(1.5); margin-right: 12px; cursor: pointer; }
        .doc-label { font-weight: bold; color: #374151; font-size: 1.1rem; cursor: pointer; flex-grow: 1; }
        .doc-date-input { border: 1px solid #d1d5db; border-radius: 4px; padding: 4px 8px; font-size: 1rem; width: 140px; }
        .detail-grid { display: grid; grid-template-columns: 80px 1fr; gap: 10px; font-size: 1rem; border-bottom: 1px dashed #e5e7eb; padding-bottom: 8px; margin-bottom: 8px; }
        .detail-label { font-weight: bold; color: var(--nexus-navy); display: flex; align-items: center; font-size: 0.95rem; }
        .manager-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; justify-content: flex-end; }
        .manager-panel { width: 100%; md:width: 90%; max-width: 900px; background: white; height: 100%; box-shadow: -4px 0 15px rgba(0,0,0,0.2); display: flex; flex-direction: column; }
        .case-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .case-table th { background: #e2e8f0; padding: 10px; text-align: left; position: sticky; top: 0; }
        .case-table td { padding: 10px; border-bottom: 1px solid #eee; }
        .status-badge { padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        .status-badge.active { background-color: #dbeafe; color: #1e40af; }
        .status-badge.closed { background-color: #dcfce7; color: #166534; }
        .sync-status { display: flex; align-items: center; font-size: 0.8rem; margin-left: 10px; color: #666; }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; background-color: #ccc; margin-right: 5px; transition: all 0.3s; }
        .sync-status.syncing .sync-dot { background-color: #fbbf24; box-shadow: 0 0 5px #fbbf24; animation: pulse 1s infinite; }
        .sync-status.success .sync-dot { background-color: #10b981; }
        .sync-status.error .sync-dot { background-color: #ef4444; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        .suggestions-box { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; max-height: 180px; overflow-y: auto; z-index: 50; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .suggestion-item { padding: 8px 12px; cursor: pointer; font-size: 0.9rem; border-bottom: 1px solid #f3f4f6; }
        .suggestion-item:hover { background-color: #f0f9ff; }
        .person-row { display: flex; flex-direction: column; gap: 4px; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px dashed #eee; }
        @media(min-width: 640px) { .person-row { flex-direction: row; align-items: center; border-bottom: none; } }
        .role-select { border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.8rem; padding: 4px; background-color: #f9fafb; color: var(--nexus-navy); font-weight: bold; width: 100%; sm:width: 75px; flex-shrink: 0; }
        .person-name-group { flex: 1; position: relative; min-width: 0; width: 100%; }
        .person-phone-input { width: 100%; flex-shrink: 0; }
        @media(min-width: 640px) { .person-phone-input { width: 110px; } }
        .calendar-section { margin-top: 20px; }
        .calendar-container { display: grid; grid-template-columns: 1fr; gap: 15px; }
        @media (min-width: 768px) { .calendar-container { grid-template-columns: repeat(2, 1fr); } }
        .calendar-month { background: white; border: 1px solid #ccc; border-radius: 4px; padding: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .cal-header { text-align: center; font-weight: bold; color: var(--nexus-navy); border-bottom: 2px solid var(--nexus-gold); padding: 4px 0; margin-bottom: 4px; font-size: 0.9rem; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; text-align: center; }
        .cal-day-header { font-size: 0.7rem; color: #666; font-weight: bold; padding: 2px 0; }
        .cal-cell { position: relative; height: 40px; border: 1px solid #f3f4f6; font-size: 0.8rem; display: flex; justify-content: center; padding-top: 2px; }
        .cal-cell.holiday { background-color: #fee2e2; color: #dc2626; font-weight: bold; }
        .cal-cell.weekend { color: #dc2626; }
        .cal-marker { position: absolute; bottom: 2px; left: 1px; right: 1px; font-size: 0.6rem; color: white; border-radius: 2px; padding: 1px 0; font-weight: bold; }
        .marker-sign { background-color: #2563eb; } .marker-seal { background-color: #ca8a04; } .marker-tax { background-color: #9333ea; } .marker-close { background-color: #dc2626; }
        .print-only { display: none; }
        .print-grid-4 { display: grid; grid-template-columns: 1fr; gap: 10px; }
        @media (min-width: 768px) { .print-grid-4 { grid-template-columns: repeat(4, 1fr); } }
        .print-finance-row { display: grid; grid-template-columns: 1fr; gap: 10px; }
        @media (min-width: 768px) { .print-finance-row { grid-template-columns: 1fr 1fr; } }
        .print-finance-grid { display: grid; grid-template-columns: 45% 53%; gap: 12px 2%; align-items: end; }
        .print-people-row { display: grid; grid-template-columns: 1fr; gap: 10px; }
        @media (min-width: 768px) { .print-people-row { grid-template-columns: 1fr 1fr; } }
        .print-admin-row { display: grid; grid-template-columns: 1fr; gap: 12px; }
        @media (min-width: 1024px) { .print-admin-row { grid-template-columns: 1.25fr 0.95fr 1.05fr; } }
        .doc-list-container { display: grid; grid-template-columns: 1fr; gap: 4px; }
        @media (min-width: 640px) { .doc-list-container { grid-template-columns: 1fr 1fr; gap: 4px 10px; } }
        @media print {
            @page { margin: 5mm 8mm; size: A4 portrait; }
            body { background: white; font-size: 10pt; line-height: 1.2; color: #000; user-select: auto; }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            #app { max-width: 210mm !important; width: 100% !important; margin: 0 auto !important; padding: 0 !important; box-shadow: none !important; }
            .page-one-container { display: flex; flex-direction: column; height: 98vh; justify-content: flex-start; page-break-after: always; gap: 2px; }
            header { margin-bottom: 2px !important; padding-bottom: 2px !important; border-bottom: 2px solid #000 !important; }
            .timeline-wrapper { padding: 4px 0 !important; margin-bottom: 4px !important; overflow: hidden; }
            .step-icon { width: 32px !important; height: 32px !important; border-width: 2px !important; font-size: 12pt !important; }
            .card { box-shadow: none !important; border: 2px solid #555 !important; margin-bottom: 4px !important; padding: 4px 6px !important; break-inside: avoid; }
            input, select, textarea { font-size: 10pt !important; font-weight: 600 !important; border: none !important; border-bottom: 1px solid #555 !important; background: transparent !important; color: black !important; padding: 0 !important; height: auto !important; }
            .nexus-input { border: none !important; border-bottom: 1px solid #555 !important; }
            .print-grid-4 { display: grid; grid-template-columns: 1.6fr 4.4fr 2.4fr 1.6fr; gap: 10px; }
            .print-finance-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
            .person-row { display: grid !important; grid-template-columns: 40px 1fr 90px !important; gap: 8px; align-items: center; border-bottom: 1px dotted #ccc; }
            .print-admin-row { display: grid; grid-template-columns: 1.25fr 0.95fr 1.05fr; gap: 12px; }
            .doc-row { border: none; background: transparent; padding: 2px 0; }
            .print-notes-display { display: block !important; white-space: pre-wrap; font-size: 10pt; border-bottom: 1px solid #000; min-height: 50px; }
            .calendar-section { break-before: page; page-break-before: always; display: block !important; margin-top: 0; padding-top: 10px; }
            .role-select { appearance: none; border: none; font-weight: 800; padding: 0; }
            .unit-tag { color: black; }
        }
    </style>
</head>
<body class="p-2 md:p-4 bg-gray-100">

<div id="app" class="w-full md:max-w-5xl mx-auto bg-white p-4 md:p-6 shadow-xl min-h-screen print:max-w-[210mm] print:shadow-none print:p-0 print:block">
    
    <div v-if="autoLoadedMsg" class="no-print fixed top-4 right-4 bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded shadow-lg z-50 animate-bounce cursor-pointer" @click="autoLoadedMsg=null">
        <p class="font-bold"><i class="fas fa-check-circle mr-2"></i>{{ autoLoadedMsg }}</p>
    </div>

    <div class="page-one-container">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-end mb-4 border-b-2 border-gray-200 pb-2">
            <div class="flex items-center gap-2 mb-2 md:mb-0">
                <div class="w-12 h-12 bg-navy text-white rounded flex items-center justify-center text-2xl font-bold print:w-10 print:h-10 print:text-xl print:border print:border-black print:text-black print:bg-white">宏</div>
                <div>
                    <h1 class="text-xl md:text-2xl font-bold text-navy tracking-wide leading-tight print:text-xl">宏國 x 易丞地政</h1>
                    <div class="flex items-center gap-2">
                        <p class="text-xs text-gold font-bold tracking-widest print:text-[10pt]">SMART COMMAND v34.8</p>
                        <div class="sync-status no-print" :class="syncStatusClass">
                            <div class="sync-dot"></div>
                            <span v-if="syncState === 'idle'">已就緒</span>
                            <span v-if="syncState === 'syncing'">同步中...</span>
                            <span v-if="syncState === 'success'" class="text-green-600">同步成功</span>
                            <span v-if="syncState === 'error'" class="text-red-500">同步失敗</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex flex-wrap gap-2 no-print w-full md:w-auto">
                <button @click="forceCloudSync" class="flex-1 md:flex-none flex items-center justify-center px-2 py-2 bg-blue-50 text-blue-600 rounded hover:bg-blue-100 text-sm border border-blue-200" title="從雲端下載最新資料 (同步)">
                    <i class="fas fa-cloud-download-alt mr-1"></i> 雲端載入
                </button>
                <button @click="showManager = true" class="flex-1 md:flex-none flex items-center justify-center px-3 py-2 bg-gray-700 text-white rounded hover:bg-gray-800 text-sm border border-gray-600">
                    <i class="fas fa-folder-open mr-1"></i> 後台
                </button>
                <button @click="resetForm(true)" class="flex-1 md:flex-none flex items-center justify-center px-3 py-2 bg-orange-500 text-white rounded hover:bg-orange-600 text-sm shadow-md font-bold">
                    <i class="fas fa-plus-circle mr-1"></i> 新增案件
                </button>
                <button @click="saveAndSync" class="flex-1 md:flex-none flex items-center justify-center px-4 py-2 bg-green-600 text-white border border-green-700 rounded hover:bg-green-700 text-sm shadow-md">
                    <i class="fas fa-save mr-1"></i> 儲存(上傳)
                </button>
                <button @click="printPage" class="flex-1 md:flex-none px-4 py-2 bg-navy text-white rounded text-sm hover:bg-black shadow-lg">
                    <i class="fas fa-print mr-1"></i> 列印
                </button>
            </div>
        </header>

        <div v-if="currentCaseIndex > -1" class="no-print bg-blue-50 border border-blue-200 text-blue-800 px-4 py-2 rounded mb-4 flex justify-between items-center text-sm">
            <span class="font-bold truncate"><i class="fas fa-edit mr-2"></i>編輯模式: {{form.address || '未命名案件'}}</span>
            <button @click="resetForm(true)" class="text-xs bg-white border border-blue-300 px-2 py-1 rounded hover:bg-blue-100 ml-2">退出並新增</button>
        </div>

        <div class="card bg-white border border-gray-200 rounded p-4 mb-2">
            <div class="timeline-wrapper">
                <div class="timeline-line-bg"></div>
                <div class="timeline-steps">
                    <div class="step-item" :class="{ active: form.contractDate }"><div class="step-icon"><i class="fas fa-file-signature"></i></div><div class="step-title">1.簽約</div><div class="step-date">{{ formatDate(form.contractDate) }}</div></div>
                    <div class="step-item" :class="{ active: form.sealDate }"><div class="step-icon"><i class="fas fa-stamp"></i></div><div class="step-title">2.用印</div><div class="step-date">{{ formatDate(form.sealDate) }}</div></div>
                    <div class="step-item" :class="{ active: form.taxDate }"><div class="step-icon"><i class="fas fa-file-invoice-dollar"></i></div><div class="step-title">3.完稅</div><div class="step-date">{{ formatDate(form.taxDate) }}</div></div>
                    <div class="step-item" :class="{ active: form.closingDate }"><div class="step-icon"><i class="fas fa-home"></i></div><div class="step-title">4.結案</div><div class="step-date">{{ formatDate(form.closingDate) }}</div></div>
                </div>
            </div>
            <div class="print-grid-4 mt-2 pt-2 border-t border-gray-100">
                <div><label class="text-xs font-bold text-gray-500 uppercase block">案件名稱</label><input v-model="form.propertyName" class="nexus-input font-bold text-navy" placeholder="案名"></div>
                <div><label class="text-xs font-bold text-gray-500 uppercase block">地址</label><input v-model="form.address" class="nexus-input" placeholder="地址"></div>
                <div class="relative"><label class="text-xs font-bold text-gray-500 uppercase block">地號/建號</label><input v-model="form.landBuildNo" class="nexus-input" placeholder="地號、建號"></div>
                <div class="relative">
                    <label class="text-xs font-bold text-gray-500 uppercase block">成交總價</label>
                    <input type="number" v-model="form.totalPrice" class="nexus-input font-mono font-bold" :class="{'bg-red-50 text-red-600': priceMismatch}">
                    <span class="unit-tag">萬</span>
                </div>
            </div>
        </div>

        <div class="print-finance-row gap-2 mb-2">
            <div class="card bg-white border border-gray-200 rounded p-3">
                <h3 class="text-sm font-bold text-navy mb-2 border-l-4 border-gold pl-2 print:text-base">款項與時程 (金額:萬 | 日期)</h3>
                <div class="print-finance-grid">
                    <div class="relative border border-gray-100 rounded px-2 bg-gray-50 print:bg-white"><label class="text-xs text-gray-400 font-bold block">1. 簽約</label><input v-model="form.paymentContract" class="nexus-input font-mono text-center p-1 bg-transparent"><span class="unit-tag">萬</span></div>
                    <div class="relative"><input type="date" v-model="form.contractDate" class="nexus-input text-xs w-full p-1 font-bold text-blue-800"></div>
                    <div class="relative border border-gray-100 rounded px-2 bg-gray-50 print:bg-white"><label class="text-xs text-gray-400 font-bold block">2. 用印</label><input v-model="form.paymentSeal" class="nexus-input font-mono text-center p-1 bg-transparent"><span class="unit-tag">萬</span></div>
                    <div class="relative"><input type="date" v-model="form.sealDate" class="nexus-input text-xs w-full p-1 font-bold text-blue-800"></div>
                    <div class="relative border border-gray-100 rounded px-2 bg-gray-50 print:bg-white"><label class="text-xs text-gray-400 font-bold block">3. 完稅</label><input v-model="form.paymentTax" class="nexus-input font-mono text-center p-1 bg-transparent"><span class="unit-tag">萬</span></div>
                    <div class="relative"><input type="date" v-model="form.taxDate" class="nexus-input text-xs w-full p-1 font-bold text-blue-800"></div>
                    <div class="relative border border-gray-100 rounded px-2 bg-gray-50 print:bg-white"><label class="text-xs text-gray-400 font-bold block">4. 尾款</label><input v-model="form.paymentBalance" class="nexus-input font-mono text-center p-1 bg-transparent"><span class="unit-tag">萬</span></div>
                    <div class="relative"><input type="date" v-model="form.closingDate" class="nexus-input text-xs w-full p-1 font-bold text-blue-800"></div>
                </div>
            </div>
            <div class="card bg-white border border-gray-200 rounded p-3">
                <h3 class="text-sm font-bold text-navy mb-2 border-l-4 border-gold pl-2 print:text-base">履約保證</h3>
                <div class="grid grid-cols-1 gap-1">
                    <div><label class="text-xs text-gray-400 block">編號</label><input v-model="form.escrowNumber" class="nexus-input font-mono text-blue-800 text-sm"></div>
                    <div><label class="text-xs text-gray-400 block">銀行/戶名</label><input v-model="form.escrowName" class="nexus-input text-sm"></div>
                    <div><label class="text-xs text-gray-400 block">分行</label><input v-model="form.escrowBranch" class="nexus-input text-sm"></div>
                </div>
            </div>
        </div>

        <div class="print-people-row gap-2 mb-2">
            <div class="card bg-blue-50 border border-blue-200 rounded p-3 print:bg-white print:border-gray-300">
                <h3 class="text-sm font-bold text-navy mb-2 print:text-base">買賣雙方</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <div class="flex justify-between items-center mb-1"><label class="text-xs font-bold text-gray-500 block">賣方 Seller</label><button @click="addPerson('sellers')" class="no-print text-xs text-blue-600">+增</button></div>
                        <div v-for="(p, idx) in form.sellers" :key="'s'+idx" class="person-row">
                            <select v-model="p.role" class="role-select"><option>本人</option><option>代理人</option><option>共有人</option></select>
                            <input v-model="p.name" class="nexus-input font-bold p-1 text-sm flex-1" placeholder="姓名">
                            <input v-model="p.phone" class="nexus-input font-mono text-xs p-1 w-24" placeholder="電話">
                            <button v-if="form.sellers.length > 1" @click="removePerson('sellers', idx)" class="no-print text-red-400 ml-1">×</button>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-1"><label class="text-xs font-bold text-gray-500 block">買方 Buyer</label><button @click="addPerson('buyers')" class="no-print text-xs text-blue-600">+增</button></div>
                        <div v-for="(p, idx) in form.buyers" :key="'b'+idx" class="person-row">
                            <select v-model="p.role" class="role-select"><option>本人</option><option>代理人</option><option>共有人</option></select>
                            <input v-model="p.name" class="nexus-input font-bold p-1 text-sm flex-1" placeholder="姓名">
                            <input v-model="p.phone" class="nexus-input font-mono text-xs p-1 w-24" placeholder="電話">
                            <button v-if="form.buyers.length > 1" @click="removePerson('buyers', idx)" class="no-print text-red-400 ml-1">×</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex flex-col gap-2">
                <div class="card bg-white border border-gray-200 rounded p-3">
                    <h3 class="text-sm font-bold text-navy print:text-base mb-1">承辦團隊</h3>
                    <div class="flex flex-wrap gap-3">
                        <label v-for="s in staffList" :key="s.name" class="flex items-center cursor-pointer bg-gray-50 px-2 py-1 rounded border hover:bg-gray-100 select-none print:bg-white print:border-0 print:p-0">
                            <input type="checkbox" :value="s.name" v-model="selectedStaff" class="w-4 h-4 mr-1">
                            <span class="text-sm font-bold">{{s.name}}</span>
                        </label>
                    </div>
                </div>
                <div class="card bg-white border border-gray-200 rounded p-3 flex-1">
                    <h3 class="text-sm font-bold text-navy print:text-base">銷售/開發</h3>
                    <div class="grid grid-cols-2 gap-2 mt-1">
                        <div><input v-model="form.salesAgent" class="nexus-input text-sm p-1" placeholder="銷售"></div>
                        <div><input v-model="form.devAgent" class="nexus-input text-sm p-1" placeholder="開發"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card bg-white border border-gray-200 rounded p-3 mt-2">
            <h3 class="text-sm font-bold text-navy mb-2 border-l-4 border-gold pl-2 print:text-base">行政細節與備註</h3>
            <div class="print-admin-row">
                <div class="detail-grid">
                    <div class="detail-label">買方預收</div>
                    <div class="flex items-center gap-2"><input v-model="form.buyerPrePay" class="nexus-input text-sm p-1" placeholder="金額"><label class="text-xs"><input type="checkbox" v-model="form.buyerPrePayRemit">已匯</label></div>
                </div>
                <div class="col-span-2">
                    <textarea v-model="form.notes" rows="2" class="nexus-input w-full text-sm no-print" placeholder="備註：交屋細節、特殊約定..."></textarea>
                    <div class="print-notes-display print-only">{{ form.notes }}</div>
                </div>
            </div>
        </div>

        <div class="preview-card card bg-navy text-white rounded p-3 mt-2 no-print">
            <div class="flex justify-between items-center mb-1 border-b border-gray-600 pb-1">
                <h3 class="text-xs font-bold"><i class="fab fa-line mr-1"></i> LINE 複製文字</h3>
                <button @click="copyToClipboard" class="text-[10px] bg-gold px-2 rounded hover:bg-yellow-600">複製</button>
            </div>
            <div class="text-xs font-mono whitespace-pre-wrap h-32 overflow-y-auto text-gray-200">{{ previewText }}</div>
        </div>

        <footer class="mt-auto text-center text-[9px] text-gray-400 font-bold pt-2 no-print">宏國地政 | 易丞地政</footer>
    </div>

    <div v-if="showManager" class="manager-overlay no-print" @click.self="showManager = false">
        <div class="manager-panel">
            <div class="p-4 bg-navy text-white flex justify-between items-center">
                <h2 class="text-lg font-bold">案件資料庫 (共 {{cases.length}} 筆)</h2>
                <button @click="showManager = false" class="text-2xl hover:text-gray-300">×</button>
            </div>
            <div class="p-2 bg-gray-100 flex justify-between items-center border-b">
                 <button @click="forceCloudSync" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                    <i class="fas fa-sync-alt mr-1"></i> 立即同步雲端
                 </button>
                 <span class="text-xs text-gray-500">提示: 點擊「儲存」會自動同步</span>
            </div>
            <div class="flex-1 overflow-y-auto p-4">
                <table class="case-table">
                    <thead><tr><th>簽約日</th><th>客戶</th><th>地址</th><th>操作</th></tr></thead>
                    <tbody>
                        <tr v-for="(c, idx) in cases" :key="idx" :class="{'bg-yellow-50': idx === currentCaseIndex}">
                            <td>{{ c['簽約日'] }}</td>
                            <td>{{ c['客戶姓名(買/賣方)'] }}</td>
                            <td class="truncate max-w-[150px]">{{ c['地址'] }}</td>
                            <td>
                                <button @click="editCase(idx)" class="text-blue-600 mr-2 hover:underline">編輯</button>
                                <button @click="deleteCase(idx)" class="text-red-400 hover:text-red-600">刪除</button>
                            </td>
                        </tr>
                        <tr v-if="cases.length === 0">
                            <td colspan="4" class="text-center py-4 text-gray-500">目前尚無資料，請嘗試點擊「雲端載入」</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="calendar-section no-print:mt-10">
        <h2 class="text-center font-bold text-lg mb-4 text-navy border-b-2 border-gold pb-2 print:text-black">案件進度行事曆</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div v-for="month in generatedCalendar" :key="month.id" class="calendar-month">
                <div class="cal-header">{{ month.title }}</div>
                <div class="cal-grid">
                    <div class="cal-day-header text-red-600">日</div><div class="cal-day-header">一</div><div class="cal-day-header">二</div><div class="cal-day-header">三</div><div class="cal-day-header">四</div><div class="cal-day-header">五</div><div class="cal-day-header text-red-600">六</div>
                    <div v-for="n in month.startDay" :key="'e'+n" class="cal-cell bg-gray-50"></div>
                    <div v-for="day in month.days" :key="day.dateStr" class="cal-cell" :class="{ 'holiday': day.isHoliday || day.isWeekend }">
                        <span>{{ day.dayNum }}</span>
                        <div v-if="day.dateStr === form.contractDate" class="cal-marker marker-sign">簽</div>
                        <div v-if="day.dateStr === form.sealDate" class="cal-marker marker-seal">用</div>
                        <div v-if="day.dateStr === form.taxDate" class="cal-marker marker-tax">完</div>
                        <div v-if="day.dateStr === form.closingDate" class="cal-marker marker-close">結</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    if (typeof Vue === 'undefined') {
        alert("⚠️ 系統錯誤：無法載入核心程式 (Vue.js)。\n請檢查您的網路連線，或防火牆是否阻擋了 unpkg.com");
    }

    const { createApp, ref, computed, onMounted } = Vue;
    const holidays = [
        '2025-01-01', '2025-01-25', '2025-01-26', '2025-01-27', '2025-01-28', '2025-01-29', '2025-01-30', '2025-01-31', '2025-02-01', '2025-02-02', 
        '2025-02-28', '2025-03-01', '2025-03-02', '2025-04-03', '2025-04-04', '2025-04-05', '2025-04-06', '2025-05-30', '2025-05-31', '2025-06-01', 
        '2025-10-04', '2025-10-05', '2025-10-06', '2025-10-10', '2025-10-11', '2025-10-12',
        '2026-01-01', '2026-02-13', '2026-02-14', '2026-02-15', '2026-02-16', '2026-02-17', '2026-02-18', '2026-02-19', '2026-02-20', '2026-02-21', '2026-02-22'
    ];

    try {
        createApp({
            setup() {
                // ==========================================================
                // 您的專屬正確網址 (v34.8 Updated)
                // ==========================================================
                const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyEMiwYwZ0L3hFqsNbIK2D4iceUJAwF6CkyWwCSXLNUb0MXJzouAUkQwcKlxtVLBuRzYQ/exec';
                
                const staffList = [
                    { name: "宜婷", phone: "0910-854-444" }, { name: "淑玲", phone: "0910-111-088" },
                    { name: "蕙蓁", phone: "0911-905-270" }, { name: "美汎", phone: "0927-055-226" }
                ];
                
                const selectedStaff = ref([]); 
                const showManager = ref(false);
                const autoLoadedMsg = ref(null);
                const syncState = ref('idle');
                const cases = ref([]);
                const currentCaseIndex = ref(-1);

                const form = ref({
                    contractDate: new Date().toISOString().split('T')[0],
                    sealDate: '', taxDate: '', closingDate: '',
                    paymentContract: '', paymentSeal: '', paymentTax: '', paymentBalance: '',
                    propertyName: '', address: '', landBuildNo: '', totalPrice: '',
                    escrowNumber: '', escrowName: '', escrowBranch: '',
                    sellers: [{ name: '', phone: '', role: '本人' }],
                    buyers: [{ name: '', phone: '', role: '本人' }],
                    salesAgent: '', devAgent: '', notes: '', buyerPrePay: '', buyerPrePayRemit: false
                });

                const defaultForm = JSON.parse(JSON.stringify(form.value));

                const priceSum = computed(() => {
                    const p1 = parseFloat(form.value.paymentContract) || 0;
                    const p2 = parseFloat(form.value.paymentSeal) || 0;
                    const p3 = parseFloat(form.value.paymentTax) || 0;
                    const p4 = parseFloat(form.value.paymentBalance) || 0;
                    return p1 + p2 + p3 + p4;
                });
                const priceMismatch = computed(() => {
                    const total = parseFloat(form.value.totalPrice);
                    if (!total) return false;
                    return Math.abs(total - priceSum.value) > 0.01;
                });

                const handleCloudSync = async (action) => {
                    syncState.value = 'syncing';
                    try {
                        let opts = {};
                        if (action === 'push') {
                            // POST: 上傳資料
                            opts = {
                                method: 'POST',
                                body: JSON.stringify({ data: cases.value }),
                                headers: { "Content-Type": "text/plain;charset=utf-8" }
                            };
                        }

                        const res = await fetch(GOOGLE_SCRIPT_URL, opts);
                        const json = await res.json();

                        if (json.result === 'error') {
                            throw new Error(json.message);
                        }

                        if (action === 'pull') {
                            if (Array.isArray(json)) {
                                cases.value = json;
                                localStorage.setItem('nexus_cases_db', JSON.stringify(cases.value));
                                autoLoadedMsg.value = `成功載入 ${cases.value.length} 筆案件`;
                            }
                        } else {
                            autoLoadedMsg.value = `資料已同步上傳`;
                        }
                        
                        syncState.value = 'success';
                        setTimeout(() => { syncState.value = 'idle'; autoLoadedMsg.value = null; }, 3000);

                    } catch (e) { 
                        console.error(e);
                        syncState.value = 'error'; 
                        alert("同步發生問題：\n" + e.message);
                    }
                };
                
                const forceCloudSync = () => {
                    if(confirm('確定要從雲端重新下載資料嗎？(本地未儲存的修改可能會遺失)')) {
                        handleCloudSync('pull');
                    }
                };

                const forceCloudUpload = () => {
                    if(confirm('確定要將目前的資料庫「強制上傳」覆蓋雲端資料嗎？')) {
                        handleCloudSync('push');
                    }
                };

                onMounted(() => {
                    const savedCases = localStorage.getItem('nexus_cases_db');
                    if (savedCases) cases.value = JSON.parse(savedCases);
                    handleCloudSync('pull');
                });

                const editCase = (idx) => {
                    currentCaseIndex.value = idx;
                    const c = cases.value[idx];
                    Object.assign(form.value, JSON.parse(JSON.stringify(defaultForm))); 

                    form.value.address = c['地址'];
                    form.value.propertyName = c['案名'] || '';
                    form.value.contractDate = c['簽約日'] ? c['簽約日'].replace(/\./g, '-') : ''; 
                    form.value.totalPrice = (c['售價(萬)']||'').replace('萬','');
                    
                    if(c['_sellers_json']) {
                        try { form.value.sellers = JSON.parse(c['_sellers_json']); } catch(e){}
                    }
                    if(c['_buyers_json']) {
                        try { form.value.buyers = JSON.parse(c['_buyers_json']); } catch(e){}
                    }
                    
                    showManager.value = false;
                };
                
                const deleteCase = (idx) => {
                    if(confirm("確定刪除此案件？(此動作將同步刪除雲端資料)")) {
                        cases.value.splice(idx, 1);
                        localStorage.setItem('nexus_cases_db', JSON.stringify(cases.value));
                        handleCloudSync('push'); 
                        if(currentCaseIndex.value === idx) resetForm(false);
                    }
                }

                const saveAndSync = () => {
                    const sellerNames = form.value.sellers.map(s => s.name).join('、');
                    const buyerNames = form.value.buyers.map(b => b.name).join('、');
                    
                    const rowData = {
                        '簽約日': form.value.contractDate ? form.value.contractDate.replace(/-/g, '.') : '',
                        '客戶姓名(買/賣方)': `${sellerNames} / ${buyerNames}`,
                        '地址': form.value.address,
                        '案名': form.value.propertyName,
                        '售價(萬)': form.value.totalPrice + '萬',
                        '_sellers_json': JSON.stringify(form.value.sellers),
                        '_buyers_json': JSON.stringify(form.value.buyers),
                        ...(currentCaseIndex.value > -1 ? cases.value[currentCaseIndex.value] : {}) 
                    };
                    
                    rowData['簽約日'] = form.value.contractDate ? form.value.contractDate.replace(/-/g, '.') : '';
                    rowData['客戶姓名(買/賣方)'] = `${sellerNames} / ${buyerNames}`;
                    rowData['地址'] = form.value.address;
                    rowData['案名'] = form.value.propertyName;

                    if (currentCaseIndex.value > -1) cases.value[currentCaseIndex.value] = rowData;
                    else cases.value.push(rowData);
                    
                    localStorage.setItem('nexus_cases_db', JSON.stringify(cases.value));
                    handleCloudSync('push');
                };

                const resetForm = (confirmAction) => { 
                    if(confirmAction && !confirm("確定要清空目前表單並新增案件嗎？(未儲存的內容將會消失)")) return;
                    currentCaseIndex.value = -1; 
                    Object.assign(form.value, JSON.parse(JSON.stringify(defaultForm))); 
                    selectedStaff.value = [];
                    showManager.value = false;
                    autoLoadedMsg.value = "已開啟新案件表單";
                    setTimeout(()=>autoLoadedMsg.value=null, 2000);
                };

                const formatDate = (d) => d ? d.split('-')[1]+'/'+d.split('-')[2] : '--/--';
                const addPerson = (type) => form.value[type].push({ name: '', phone: '', role: '本人' });
                const removePerson = (type, idx) => form.value[type].splice(idx, 1);
                
                const previewText = computed(() => `簽約案：${form.value.propertyName}\n地址：${form.value.address}\n買方：${form.value.buyers.map(b=>b.name).join('、')}\n賣方：${form.value.sellers.map(s=>s.name).join('、')}`);
                const copyToClipboard = () => { navigator.clipboard.writeText(previewText.value).then(()=>alert('已複製')); };
                
                const generatedCalendar = computed(() => {
                    if (!form.value.contractDate) return [];
                    const start = new Date(form.value.contractDate);
                    const end = form.value.closingDate ? new Date(form.value.closingDate) : new Date(start.getFullYear(), start.getMonth() + 3, 1);
                    const startDate = new Date(start.getFullYear(), start.getMonth(), 1);
                    const endDate = new Date(end.getFullYear(), end.getMonth() + 1, 0);
                    const months = [];
                    let current = new Date(startDate);
                    while (current <= endDate) {
                        const year = current.getFullYear();
                        const month = current.getMonth();
                        const monthTitle = `${year}年 ${month + 1}月`;
                        const daysInMonth = new Date(year, month + 1, 0).getDate();
                        const startDay = new Date(year, month, 1).getDay(); 
                        const days = [];
                        for (let i = 1; i <= daysInMonth; i++) {
                            const dateObj = new Date(year, month, i);
                            const mStr = (month + 1).toString().padStart(2, '0');
                            const dStr = i.toString().padStart(2, '0');
                            const dateStr = `${year}-${mStr}-${dStr}`;
                            const dayOfWeek = dateObj.getDay();
                            const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                            const isHoliday = holidays.includes(dateStr);
                            days.push({ dayNum: i, dateStr, isWeekend, isHoliday });
                        }
                        months.push({ id: `${year}-${month}`, title: monthTitle, startDay, days });
                        current.setMonth(current.getMonth() + 1);
                    }
                    return months;
                });

                return {
                    form, cases, staffList, selectedStaff, showManager, currentCaseIndex, editCase, saveAndSync, deleteCase,
                    formatDate, addPerson, removePerson, previewText, copyToClipboard, autoLoadedMsg,
                    syncStatusClass: computed(() => ({ 'syncing': syncState.value === 'syncing', 'success': syncState.value === 'success', 'error': syncState.value === 'error' })),
                    syncState, 
                    forceCloudSync, 
                    forceCloudUpload,
                    resetForm, priceMismatch, priceSum, generatedCalendar,
                    printPage: () => window.print()
                };
            }
        }).mount('#app');
    
    } catch (e) {
        alert("程式執行錯誤：" + e);
    }
</script>

</body>
</html>